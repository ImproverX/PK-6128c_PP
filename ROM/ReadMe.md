# Прошивка для ПК-6128ц++
* [test6128.asm](/ROM/test6128.asm) -- исходники тестовой части прошивки.
* [clear.asm](/ROM/clear.asm) -- исходники "пустой" части прошивки. Назначение -- переключение на тестовую часть, в последсдвии будет заменено на основную рабочую прошивку ПК-6128ц++.
* [ROM.bin](/ROM/ROM.bin) -- откомпилированная и собранная прошивка.

Состав прошивки ROM.bin:<br>
Адреса 0000h..7FFFh -- тестовая прошивка с дополнительным тестовым ПО.<br>
Адреса 8000h..FFFFh -- основная прошивка, в данном случае clear.asm.

## Сборка тестовой прошивки
1. Компилируем test6128.asm в test6128.obj
2. Дописываем в конец дополнительное ПО:<br>
   copy /b test6128.obj+testtp_m.rom+TEST_(PK6128TS).COM test6128.epr
3. В любом HEX-редакторе дополняем файл test6128.epr до 32кб, последний байт -- контрольная сумма.

## Описание тестовой прошивки
При старте прошивка выполняет самотестирование и при совпадении контрольной суммы переходит в режим мигания
индикатором "РУС/ЛАТ", нажатие на клавиш "СС", "УС" или "РУС/ЛАТ" выводит через ВИ53 частоты
3, 2 или 1 кГц соответственно по разным каналам. При этом не используется основная память и прерывания.

В это же время выполняется тестирование экрана:
* при нажатии УС, кроме вывода звука, заполняется экранная область значением 55h, устанавливается цвет бордюра 00h
* при нажатии СС экранная область заполняется значением FFh, устанавливается цвет бордюра 00h
* при нажатии РУС экранная область заполняется значением 00h, устанавливается цвет бордюра 0Fh
* при нажатии УС+РУС выполняется загрузка палитры, экран заполняется ч/б градиентом по типу этого теста, устанавливается цвет бордюра 00h. Тут используется прерывание и требуется исправное ОЗУ по адресам FFFEh-FFFFh, в случае обнаружения ошибок по этим адресам загрузка палитры и тест градиентом не выполняется.

Примечание. Заполнение видеопамяти производится без программного тестирования, ошибки будут просто видны на экране, если он подключен.

Если нажать одновременно "СС" и "РУС", то будет запущен тест клавиатуры -- нажатие клавиш будет озвучиваться, код нажатой клавиши отправляется в порт В (ПУ). Для данного теста также нужны прерывания и исправное ОЗУ.
И, как бонус, тестируется сам порт ПУ, если на нём установлена заглушка, как описано в документации к Тесту Устройств (Порт А <--> Порт В, Порт С 7-4 <--> Порт С 3-0). В случае удачного теста ПУ будет гореть индикатор РУС/ЛАТ.

Нажатие "СС"+"УС" запускает тестирование памяти в таком порядке:
1. Банк 2, экран в Банке 2
2. Банк 3, экран в Банке 2
3. Банк 0, экран в Банке 0
4. Банк 1, экран в Банке 0

Каждый банк тестируется методом: 
- простого записи/чтения, для контроля последовательно используется байты 00h/FFh, AAh/55h.
- методом записи/чтения через стек, используются слово 6699h/9966h и счётчик
- очисткой памяти (заполнением нулями) с проверкой

Обнаруженные ошибки выводятся в порт ПУ.

Если тестирование прошло без ошибок, то в память копируется тест техпрогона и выполняется программный сброс,
или, если удерживать клавишу "УС" при окончании теста памяти, то будет запущен Тест Устройств.
