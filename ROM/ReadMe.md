# Прошивка для ПК-6128ц++
* [test6128.asm](/ROM/test6128.asm) -- исходники тестовой части прошивки.
* [BOOT6128.asm](/ROM/BOOT6128.asm) -- исходники основной части прошивки, сделаны на базе [BOOTROM](https://github.com/ImproverX/BOOTROM).
* [test6128.epr](/ROM/test6128.epr), [BOOT6128.epr](/ROM/BOOT6128.epr) -- откомпилированная и собранная прошивка.

Состав прошивки:<br>
Адреса 0000h..7FFFh -- тестовая прошивка.<br>
Адреса 8000h..FFFFh -- основная прошивка.

## Описание основной части прошивки
Перезапуск с нажатыми клавишами:
|Клавиша|Режим|
|:-------|:----------|
|нет|квазидиск|
|F1|магнитофон|
|F2|жесткий диск|
|F1+F2|дисковод|
|F1+F3|сетевой адаптер|
|F3|Бейсик|
|F4|Монитор Супер-Монстр 2|
|F5|загрузка из модуля МППЗУ|
|F5+AP2|самотестирование ПЗУ|
|AP2|загрузка данных из РС через порты ПУ-LPT|
|"ВЛЕВО-ВВЕРХ"|магнитофон в формате FM9|
||*без очистки ОЗУ (кроме экранной области c адресами 0C000H-0DFFFH):*|
|**УС+F1**|**переключение на тестовую часть прошивки**|
|УС+F4|реанимация 0 блока Монитора (режим загрузки детектируется)|
|УС+F5|загрузка из модуля МППЗУ без очистки памяти|
|УС+AP2|загрузка данных из РС через порты ПУ-LPT без очистки памяти|
|УС+СТР|загрузка модуля выгрузки данных через ПУ (в Монитор)|
|УС+др.комбинации или ничего|магнитофон без очистки памяти|

Если для загрузки выбрано неподключенное устройство, загрузка будет
производиться со следующего подключенного устройства согласно приоритету:
- КД 1 (порт 10h)
- КД 2 (порт 11h)
- НЖМД
- НГМД
- МППЗУ
- сетевой адаптер
- магнитофон

## Описание тестовой прошивки
При старте прошивка выполняет самотестирование и при совпадении контрольной суммы переходит в режим мигания
индикатором "РУС/ЛАТ", нажатие на клавиш "СС", "УС" или "РУС/ЛАТ" выводит через ВИ53 частоты
3, 2 или 1 кГц соответственно по разным каналам. При этом не используется основная память и прерывания.

В это же время выполняется тестирование экрана:
* при нажатии УС, кроме вывода звука, заполняется экранная область значением 55h, устанавливается цвет бордюра 00h
* при нажатии СС экранная область заполняется значением FFh, устанавливается цвет бордюра 00h
* при нажатии РУС экранная область заполняется значением 00h, устанавливается цвет бордюра 0Fh
* при нажатии УС+РУС выполняется загрузка палитры, экран заполняется ч/б градиентом по типу этого теста, устанавливается цвет бордюра 00h. Тут используется прерывание и требуется исправное ОЗУ по адресам FFFEh-FFFFh, в случае обнаружения ошибок по этим адресам загрузка палитры и тест градиентом не выполняется.

Примечание. Заполнение видеопамяти производится без программного тестирования, ошибки будут просто видны на экране, если он подключен.

Если нажать одновременно "СС" и "РУС", то будет запущен тест клавиатуры -- нажатие клавиш будет озвучиваться, код нажатой клавиши отправляется в порт В (ПУ). Для данного теста также нужны прерывания и исправное ОЗУ.
И, как бонус, тестируется сам порт ПУ, если на нём установлена заглушка, как описано в документации к Тесту Устройств (Порт А <--> Порт В, Порт С 7-4 <--> Порт С 3-0). В случае удачного теста ПУ будет гореть индикатор РУС/ЛАТ.

Нажатие "СС"+"УС" запускает тестирование памяти в таком порядке:
1. Банк 2, экран в Банке 2
2. Банк 3, экран в Банке 2
3. Банк 0, экран в Банке 0
4. Банк 1, экран в Банке 0

Каждый банк тестируется методом: 
- простого записи/чтения, для контроля последовательно используется байты 00h/FFh, AAh/55h.
- методом записи/чтения через стек, используются слово 6699h/9966h и счётчик
- очисткой памяти (заполнением нулями) с проверкой

Обнаруженные ошибки выводятся в порт ПУ.

Если тестирование прошло без ошибок, то в память копируется тест техпрогона и выполняется программный сброс,
или, если удерживать клавишу "УС" при окончании теста памяти, то будет запущен Тест Устройств.
